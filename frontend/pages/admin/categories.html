<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Categories - Admin | Dealify</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EüõçÔ∏è%3C/text%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="stylesheet" href="../../css/components.css">
  <link rel="stylesheet" href="../../css/dashboard.css">
  <link rel="stylesheet" href="../../css/responsive.css">
  <style>
    body { font-family: 'Inter', var(--font-family); }
    .navbar { background: linear-gradient(135deg, #1E1B4B, #312E81) !important; }
    .navbar .navbar-logo, .navbar .navbar-logo span { color: #fff !important; }
    .navbar .navbar-link, .navbar .navbar-link span { color: #fff !important; }
    .admin-badge { background: linear-gradient(135deg, #EF4444, #DC2626); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px; }
    .dashboard-sidebar { background: #1E1B4B; border-right: none; }
    .sidebar-header { background: linear-gradient(135deg, #312E81, #3730A3); border-bottom: 1px solid #4338CA; }
    .sidebar-avatar { background: #EF4444 !important; color: #fff !important; }
    .sidebar-user-info h4 { color: #fff !important; }
    .sidebar-user-info p { color: #A5B4FC !important; }
    .sidebar-section-title { color: #818CF8 !important; }
    .sidebar-link { color: #C7D2FE !important; }
    .sidebar-link:hover { background: rgba(255,255,255,0.08) !important; color: #fff !important; }
    .sidebar-link.active { background: rgba(99,102,241,0.2) !important; color: #fff !important; border-left: 3px solid #818CF8; }
    .sidebar-link .badge { background: #EF4444; color: #fff; }

    /* Page-specific */
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xl); flex-wrap: wrap; gap: var(--space-md); }
    .page-header h2 { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .page-header h2 span { color: var(--muted); font-size: 0.9rem; font-weight: 400; }

    .categories-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: var(--space-lg); }
    .category-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: var(--space-lg); transition: all 0.2s; position: relative; }
    .category-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
    .category-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-md); }
    .category-icon { font-size: 2.5rem; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: var(--bg); border-radius: var(--radius-md); }
    .category-actions { display: flex; gap: 4px; }
    .category-actions button { background: none; border: none; cursor: pointer; padding: 6px; border-radius: var(--radius-sm); color: var(--muted); transition: all 0.2s; }
    .category-actions button:hover { background: var(--bg); color: var(--text-primary); }
    .category-actions button.delete-btn:hover { background: #FEE2E2; color: #DC2626; }
    .category-name { font-weight: 600; font-size: 1.05rem; margin-bottom: 4px; }
    .category-slug { color: var(--muted); font-size: 0.8rem; margin-bottom: 8px; }
    .category-desc { color: var(--text-secondary); font-size: 0.85rem; line-height: 1.5; margin-bottom: var(--space-md); }
    .category-meta { display: flex; justify-content: space-between; align-items: center; padding-top: var(--space-sm); border-top: 1px solid var(--border); }
    .category-products { font-size: 0.8rem; color: var(--muted); display: flex; align-items: center; gap: 4px; }
    .category-status { padding: 2px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; }
    .category-status.active { background: #D1FAE5; color: #065F46; }
    .category-status.inactive { background: #FEE2E2; color: #991B1B; }

    /* Toggle Switch */
    .toggle-switch { position: relative; display: inline-block; width: 38px; height: 20px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #CBD5E1; border-radius: 20px; transition: 0.3s; }
    .toggle-slider:before { position: absolute; content: ''; height: 14px; width: 14px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
    .toggle-switch input:checked + .toggle-slider { background: #8B5CF6; }
    .toggle-switch input:checked + .toggle-slider:before { transform: translateX(18px); }

    /* Modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: var(--space-lg); }
    .modal-overlay.show { display: flex; }
    .modal { background: var(--card-bg); border-radius: var(--radius-xl); padding: 0; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-xl); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: var(--space-lg) var(--space-xl); border-bottom: 1px solid var(--border); }
    .modal-header h3 { font-size: 1.1rem; font-weight: 700; }
    .modal-close { background: none; border: none; cursor: pointer; padding: 6px; border-radius: var(--radius-sm); color: var(--muted); }
    .modal-close:hover { background: var(--bg); color: var(--text-primary); }
    .modal-body { padding: var(--space-xl); }
    .modal-footer { display: flex; justify-content: flex-end; gap: var(--space-sm); padding: var(--space-lg) var(--space-xl); border-top: 1px solid var(--border); background: var(--bg); border-radius: 0 0 var(--radius-xl) var(--radius-xl); }

    .emoji-picker { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; max-height: 120px; overflow-y: auto; padding: 8px; background: var(--bg); border-radius: var(--radius-md); }
    .emoji-option { font-size: 1.4rem; cursor: pointer; padding: 4px 8px; border-radius: var(--radius-sm); border: 2px solid transparent; transition: 0.2s; }
    .emoji-option:hover { background: var(--border); }
    .emoji-option.selected { border-color: #8B5CF6; background: #EDE9FE; }

    .loading-state { text-align: center; padding: var(--space-2xl); color: var(--muted); }

    @media (max-width: 768px) {
      .categories-grid { grid-template-columns: 1fr; }
      .page-header { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>

  <div class="admin-role-strip">üõ°Ô∏è <strong>ADMIN PANEL</strong> ‚Äî Full Platform Control</div>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-inner">
      <a href="../../index.html" class="navbar-logo">Deal<span>ify</span></a>
      <div style="flex:1;"></div>
      <div class="navbar-actions">
        <span class="admin-badge">ADMIN</span>
        <div class="user-dropdown">
          <button class="navbar-link" id="userDropdownBtn">
            <i data-lucide="shield"></i>
            <span id="navUserName">Admin</span>
          </button>
          <div class="user-dropdown-menu" id="userDropdownMenu">
            <a href="dashboard.html"><i data-lucide="layout-dashboard" style="width:16px;height:16px;"></i> Dashboard</a>
            <div class="user-dropdown-divider"></div>
            <button onclick="logout()"><i data-lucide="log-out" style="width:16px;height:16px;"></i> Logout</button>
          </div>
        </div>
      </div>
      <div class="hamburger" onclick="toggleSidebar()">
        <span></span><span></span><span></span>
      </div>
    </div>
  </nav>

  <div class="toast-container" id="toastContainer"></div>

  <!-- Dashboard Layout -->
  <div class="dashboard-wrapper">
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <!-- Sidebar -->
    <aside class="dashboard-sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-avatar" id="sidebarAvatar" style="background:#FEE2E2;color:#DC2626;">A</div>
        <div class="sidebar-user-info">
          <h4 id="sidebarName">Admin</h4>
          <p style="font-size:0.7rem;color:var(--muted);">Super Admin</p>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="sidebar-section"><div class="sidebar-section-title">Overview</div></div>
        <a href="dashboard.html" class="sidebar-link"><i data-lucide="layout-dashboard"></i> Dashboard</a>

        <div class="sidebar-section"><div class="sidebar-section-title">User Management</div></div>
        <a href="users.html" class="sidebar-link"><i data-lucide="users"></i> All Users</a>
        <a href="sellers.html" class="sidebar-link"><i data-lucide="store"></i> Sellers</a>

        <div class="sidebar-section"><div class="sidebar-section-title">Catalog</div></div>
        <a href="products.html" class="sidebar-link"><i data-lucide="package"></i> Products</a>
        <a href="categories.html" class="sidebar-link active"><i data-lucide="grid-3x3"></i> Categories</a>

        <div class="sidebar-section"><div class="sidebar-section-title">Business</div></div>
        <a href="orders.html" class="sidebar-link"><i data-lucide="shopping-bag"></i> Orders</a>
        <a href="coupons.html" class="sidebar-link"><i data-lucide="ticket"></i> Coupons</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="dashboard-content">
      <div class="page-header">
        <h2><i data-lucide="grid-3x3" style="width:24px;height:24px;color:#8B5CF6;"></i> Categories <span id="totalCount"></span></h2>
        <button class="btn btn-primary" onclick="openAddModal()">
          <i data-lucide="plus" style="width:18px;height:18px;"></i> Add Category
        </button>
      </div>

      <div id="loadingState" class="loading-state">
        <i data-lucide="loader" style="width:32px;height:32px;" class="spin"></i>
        <p>Loading categories...</p>
      </div>

      <div class="categories-grid" id="categoriesGrid"></div>
    </main>
  </div>

  <!-- Add/Edit Category Modal -->
  <div class="modal-overlay" id="categoryModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">Add Category</h3>
        <button class="modal-close" onclick="closeModal()">
          <i data-lucide="x" style="width:20px;height:20px;"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="categoryForm">
          <input type="hidden" id="categoryId">

          <div class="form-group" style="margin-bottom:var(--space-lg);">
            <label class="form-label">Category Name *</label>
            <input type="text" id="catName" class="form-input" placeholder="e.g. Electronics" required>
          </div>

          <div class="form-group" style="margin-bottom:var(--space-lg);">
            <label class="form-label">Description</label>
            <textarea id="catDescription" class="form-input" rows="3" placeholder="Brief description of this category"></textarea>
          </div>

          <div class="form-group" style="margin-bottom:var(--space-lg);">
            <label class="form-label">Icon (choose emoji)</label>
            <div class="emoji-picker" id="emojiPicker"></div>
          </div>

          <div class="form-group" style="margin-bottom:var(--space-lg);">
            <label class="form-label">Sort Order</label>
            <input type="number" id="catSortOrder" class="form-input" placeholder="0" min="0">
          </div>

          <div class="form-group" style="margin-bottom:var(--space-lg);">
            <label class="form-label" style="display:flex;align-items:center;gap:8px;">
              Active 
              <label class="toggle-switch">
                <input type="checkbox" id="catIsActive" checked>
                <span class="toggle-slider"></span>
              </label>
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" id="saveBtn" onclick="saveCategory()">
          <i data-lucide="check" style="width:16px;height:16px;"></i> Save Category
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Confirm Modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal" style="max-width:400px;">
      <div class="modal-header">
        <h3>Delete Category</h3>
        <button class="modal-close" onclick="closeDeleteModal()">
          <i data-lucide="x" style="width:20px;height:20px;"></i>
        </button>
      </div>
      <div class="modal-body" style="text-align:center;">
        <div style="font-size:3rem;margin-bottom:var(--space-md);" id="deleteIcon">üì¶</div>
        <p style="font-weight:600;font-size:1.05rem;margin-bottom:4px;" id="deleteName"></p>
        <p style="color:var(--muted);font-size:0.85rem;">Are you sure you want to delete this category? This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn" style="background:#DC2626;color:#fff;" onclick="confirmDelete()">
          <i data-lucide="trash-2" style="width:16px;height:16px;"></i> Delete
        </button>
      </div>
    </div>
  </div>

  <script src="../../js/app.js"></script>
  <script>
    const emojis = ['üì±','üëî','üëó','üè†','üíÑ','‚öΩ','üìö','üß∏','üõí','üë∂','üì≤','üíç','üéÆ','üñ•Ô∏è','üéµ','üöó','‚úàÔ∏è','üé®','üåø','üêæ','üçï','üíä','üîß','üì∏','üëú','üëü','üß¥','ü™ë','üéÅ','üîå','‚åö','üéØ'];
    let allCategories = [];
    let selectedEmoji = 'üì¶';
    let deleteTargetId = null;

    // ‚îÄ‚îÄ‚îÄ‚îÄ Auth check ‚îÄ‚îÄ‚îÄ‚îÄ
    document.addEventListener('DOMContentLoaded', () => {
      const auth = getAuth();
      if (!auth || !auth.token) {
        window.location.href = '../auth/login.html';
        return;
      }
      if (auth.user && auth.user.role !== 'admin') {
        window.location.href = '../../index.html';
        return;
      }
      if (auth.user) {
        document.getElementById('navUserName').textContent = auth.user.name;
        document.getElementById('sidebarName').textContent = auth.user.name;
        document.getElementById('sidebarAvatar').textContent = auth.user.name.charAt(0).toUpperCase();
      }

      // Dropdown
      const dropdownBtn = document.getElementById('userDropdownBtn');
      const dropdownMenu = document.getElementById('userDropdownMenu');
      dropdownBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle('show');
      });
      document.addEventListener('click', () => dropdownMenu.classList.remove('show'));

      buildEmojiPicker();
      loadCategories();
      lucide.createIcons();
    });

    // ‚îÄ‚îÄ‚îÄ‚îÄ Sidebar toggle ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
      const overlay = document.getElementById('sidebarOverlay');
      if (overlay) overlay.classList.toggle('active');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Emoji Picker ‚îÄ‚îÄ‚îÄ‚îÄ
    function buildEmojiPicker() {
      const picker = document.getElementById('emojiPicker');
      picker.innerHTML = emojis.map(e => 
        `<span class="emoji-option ${e === selectedEmoji ? 'selected' : ''}" onclick="selectEmoji('${e}', this)">${e}</span>`
      ).join('');
    }

    function selectEmoji(emoji, el) {
      selectedEmoji = emoji;
      document.querySelectorAll('.emoji-option').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Load Categories ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadCategories() {
      const res = await apiCall('/categories?all=true');
      if (!res) return;

      document.getElementById('loadingState').style.display = 'none';
      allCategories = res.data || [];
      document.getElementById('totalCount').textContent = `(${allCategories.length})`;
      renderCategories();
    }

    function renderCategories() {
      const grid = document.getElementById('categoriesGrid');
      if (allCategories.length === 0) {
        grid.innerHTML = `
          <div style="grid-column:1/-1;text-align:center;padding:3rem;color:var(--muted);">
            <div style="font-size:3rem;margin-bottom:1rem;">üì¶</div>
            <p style="font-weight:600;">No categories yet</p>
            <p style="font-size:0.85rem;">Click "Add Category" to create your first one.</p>
          </div>`;
        return;
      }

      grid.innerHTML = allCategories.map(cat => `
        <div class="category-card">
          <div class="category-card-header">
            <div class="category-icon">${cat.icon || 'üì¶'}</div>
            <div class="category-actions">
              <button title="Edit" onclick='editCategory(${JSON.stringify(cat).replace(/'/g, "&#39;")})'>
                <i data-lucide="pencil" style="width:16px;height:16px;"></i>
              </button>
              <button class="delete-btn" title="Delete" onclick="deleteCategory('${cat._id}', '${cat.name}', '${cat.icon}')">
                <i data-lucide="trash-2" style="width:16px;height:16px;"></i>
              </button>
            </div>
          </div>
          <div class="category-name">${cat.name}</div>
          <div class="category-slug">/${cat.slug}</div>
          <div class="category-desc">${cat.description || '<em>No description</em>'}</div>
          <div class="category-meta">
            <div class="category-products">
              <i data-lucide="package" style="width:14px;height:14px;"></i>
              ${cat.productCount || 0} products
            </div>
            <span class="category-status ${cat.isActive ? 'active' : 'inactive'}">${cat.isActive ? 'Active' : 'Inactive'}</span>
          </div>
        </div>
      `).join('');

      lucide.createIcons();
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Modal: Add ‚îÄ‚îÄ‚îÄ‚îÄ
    function openAddModal() {
      document.getElementById('modalTitle').textContent = 'Add Category';
      document.getElementById('categoryId').value = '';
      document.getElementById('catName').value = '';
      document.getElementById('catDescription').value = '';
      document.getElementById('catSortOrder').value = '0';
      document.getElementById('catIsActive').checked = true;
      selectedEmoji = 'üì¶';
      buildEmojiPicker();
      document.getElementById('categoryModal').classList.add('show');
      lucide.createIcons();
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Modal: Edit ‚îÄ‚îÄ‚îÄ‚îÄ
    function editCategory(cat) {
      document.getElementById('modalTitle').textContent = 'Edit Category';
      document.getElementById('categoryId').value = cat._id;
      document.getElementById('catName').value = cat.name;
      document.getElementById('catDescription').value = cat.description || '';
      document.getElementById('catSortOrder').value = cat.sortOrder || 0;
      document.getElementById('catIsActive').checked = cat.isActive;
      selectedEmoji = cat.icon || 'üì¶';
      buildEmojiPicker();
      document.getElementById('categoryModal').classList.add('show');
      lucide.createIcons();
    }

    function closeModal() {
      document.getElementById('categoryModal').classList.remove('show');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Save Category ‚îÄ‚îÄ‚îÄ‚îÄ
    async function saveCategory() {
      const id = document.getElementById('categoryId').value;
      const name = document.getElementById('catName').value.trim();
      const description = document.getElementById('catDescription').value.trim();
      const sortOrder = parseInt(document.getElementById('catSortOrder').value) || 0;
      const isActive = document.getElementById('catIsActive').checked;

      if (!name) {
        showToast('Category name is required', 'error');
        return;
      }

      const body = { name, description, icon: selectedEmoji, sortOrder, isActive };

      const saveBtn = document.getElementById('saveBtn');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i data-lucide="loader" style="width:16px;height:16px;" class="spin"></i> Saving...';

      let res;
      if (id) {
        res = await apiCall(`/categories/${id}`, 'PUT', body);
      } else {
        res = await apiCall('/categories', 'POST', body);
      }

      saveBtn.disabled = false;
      saveBtn.innerHTML = '<i data-lucide="check" style="width:16px;height:16px;"></i> Save Category';
      lucide.createIcons();

      if (res && res.success) {
        showToast(id ? 'Category updated!' : 'Category created!', 'success');
        closeModal();
        loadCategories();
      } else if (res) {
        showToast(res.message || 'Failed to save', 'error');
      }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Delete ‚îÄ‚îÄ‚îÄ‚îÄ
    function deleteCategory(id, name, icon) {
      deleteTargetId = id;
      document.getElementById('deleteName').textContent = name;
      document.getElementById('deleteIcon').textContent = icon || 'üì¶';
      document.getElementById('deleteModal').classList.add('show');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('show');
      deleteTargetId = null;
    }

    async function confirmDelete() {
      if (!deleteTargetId) return;
      const res = await apiCall(`/categories/${deleteTargetId}`, 'DELETE');
      if (res && res.success) {
        showToast('Category deleted', 'success');
        closeDeleteModal();
        loadCategories();
      } else if (res) {
        showToast(res.message || 'Failed to delete', 'error');
      }
    }
  </script>
<button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
</body>
</html>
