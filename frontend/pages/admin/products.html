<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Products - Admin | Dealify</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EüõçÔ∏è%3C/text%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="stylesheet" href="../../css/components.css">
  <link rel="stylesheet" href="../../css/dashboard.css">
  <link rel="stylesheet" href="../../css/responsive.css">
  <style>
    body { font-family: 'Inter', var(--font-family); }
    .navbar { background: linear-gradient(135deg, #1E1B4B, #312E81) !important; }
    .navbar .navbar-logo, .navbar .navbar-logo span { color: #fff !important; }
    .navbar .navbar-link, .navbar .navbar-link span { color: #fff !important; }
    .admin-badge { background: linear-gradient(135deg, #EF4444, #DC2626); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px; }
    .dashboard-sidebar { background: #1E1B4B; border-right: none; }
    .sidebar-header { background: linear-gradient(135deg, #312E81, #3730A3); border-bottom: 1px solid #4338CA; }
    .sidebar-avatar { background: #EF4444 !important; color: #fff !important; }
    .sidebar-user-info h4 { color: #fff !important; }
    .sidebar-user-info p { color: #A5B4FC !important; }
    .sidebar-section-title { color: #818CF8 !important; }
    .sidebar-link { color: #C7D2FE !important; }
    .sidebar-link:hover { background: rgba(255,255,255,0.08) !important; color: #fff !important; }
    .sidebar-link.active { background: rgba(99,102,241,0.2) !important; color: #fff !important; border-left: 3px solid #818CF8; }
    .sidebar-link .badge { background: #EF4444; color: #fff; }

    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xl); flex-wrap: wrap; gap: var(--space-md); }
    .page-header h2 { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }

    /* Status Tabs */
    .status-tabs { display: flex; gap: 4px; background: var(--bg); padding: 4px; border-radius: var(--radius-md); margin-bottom: var(--space-xl); overflow-x: auto; }
    .status-tab { padding: 8px 16px; border-radius: var(--radius-sm); font-size: 0.85rem; font-weight: 500; cursor: pointer; white-space: nowrap; border: none; background: transparent; color: var(--text-secondary); transition: 0.2s; }
    .status-tab.active { background: var(--card-bg); color: var(--text-primary); box-shadow: var(--shadow-sm); font-weight: 600; }
    .status-tab .tab-count { background: var(--border); padding: 1px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 4px; }
    .status-tab.active .tab-count { background: #6366F1; color: #fff; }

    .filter-bar { display: flex; gap: var(--space-md); margin-bottom: var(--space-xl); flex-wrap: wrap; }
    .filter-bar .form-input { max-width: 300px; }

    /* Product Table */
    .products-table-wrap { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
    .products-table { width: 100%; border-collapse: collapse; }
    .products-table thead { background: var(--bg); }
    .products-table th { padding: 12px 16px; text-align: left; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--muted); letter-spacing: 0.5px; }
    .products-table td { padding: 12px 16px; border-top: 1px solid var(--border); font-size: 0.9rem; vertical-align: middle; }
    .products-table tr:hover { background: var(--bg); }

    .product-cell { display: flex; align-items: center; gap: 12px; }
    .product-thumb { width: 50px; height: 50px; border-radius: var(--radius-sm); object-fit: cover; background: var(--bg); flex-shrink: 0; }
    .product-info h4 { font-weight: 600; font-size: 0.9rem; margin-bottom: 2px; }
    .product-info p { color: var(--muted); font-size: 0.75rem; }

    .status-badge { padding: 3px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; }
    .status-badge.pending { background: #FEF3C7; color: #92400E; }
    .status-badge.approved { background: #D1FAE5; color: #065F46; }
    .status-badge.rejected { background: #FEE2E2; color: #991B1B; }

    .action-btns { display: flex; gap: 4px; }
    .action-btns button { border: none; cursor: pointer; padding: 6px 10px; border-radius: var(--radius-sm); font-size: 0.75rem; font-weight: 600; transition: 0.2s; }
    .approve-btn { background: #D1FAE5; color: #065F46; }
    .approve-btn:hover { background: #A7F3D0; }
    .reject-btn { background: #FEE2E2; color: #991B1B; }
    .reject-btn:hover { background: #FECACA; }
    .featured-btn { background: #FEF3C7; color: #92400E; }
    .featured-btn:hover { background: #FDE68A; }
    .featured-btn.is-featured { background: #F59E0B; color: #fff; }

    .pagination { display: flex; justify-content: center; gap: 4px; margin-top: var(--space-xl); }
    .pagination button { padding: 8px 14px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--card-bg); cursor: pointer; font-size: 0.85rem; }
    .pagination button.active { background: #6366F1; color: #fff; border-color: #6366F1; }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }

    .empty-state { text-align: center; padding: 3rem; color: var(--muted); }

    @media (max-width: 768px) {
      .page-header { flex-direction: column; align-items: stretch; }
      .filter-bar { flex-direction: column; }
      .filter-bar .form-input { max-width: 100%; }
      .products-table th:nth-child(n+5), .products-table td:nth-child(n+5) { display: none; }
    }
  </style>
</head>
<body>

  <div class="admin-role-strip">üõ°Ô∏è <strong>ADMIN PANEL</strong> ‚Äî Full Platform Control</div>

  <nav class="navbar">
    <div class="navbar-inner">
      <a href="../../index.html" class="navbar-logo">Deal<span>ify</span></a>
      <div style="flex:1;"></div>
      <div class="navbar-actions">
        <span class="admin-badge">ADMIN</span>
        <div class="user-dropdown">
          <button class="navbar-link" id="userDropdownBtn">
            <i data-lucide="shield"></i>
            <span id="navUserName">Admin</span>
          </button>
          <div class="user-dropdown-menu" id="userDropdownMenu">
            <a href="dashboard.html"><i data-lucide="layout-dashboard" style="width:16px;height:16px;"></i> Dashboard</a>
            <div class="user-dropdown-divider"></div>
            <button onclick="logout()"><i data-lucide="log-out" style="width:16px;height:16px;"></i> Logout</button>
          </div>
        </div>
      </div>
      <div class="hamburger" onclick="toggleSidebar()">
        <span></span><span></span><span></span>
      </div>
    </div>
  </nav>

  <div class="toast-container" id="toastContainer"></div>

  <div class="dashboard-wrapper">
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <aside class="dashboard-sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-avatar" id="sidebarAvatar" style="background:#FEE2E2;color:#DC2626;">A</div>
        <div class="sidebar-user-info">
          <h4 id="sidebarName">Admin</h4>
          <p style="font-size:0.7rem;color:var(--muted);">Super Admin</p>
        </div>
      </div>
      <nav class="sidebar-nav">
        <div class="sidebar-section"><div class="sidebar-section-title">Overview</div></div>
        <a href="dashboard.html" class="sidebar-link"><i data-lucide="layout-dashboard"></i> Dashboard</a>
        <div class="sidebar-section"><div class="sidebar-section-title">User Management</div></div>
        <a href="users.html" class="sidebar-link"><i data-lucide="users"></i> All Users</a>
        <a href="sellers.html" class="sidebar-link"><i data-lucide="store"></i> Sellers</a>
        <div class="sidebar-section"><div class="sidebar-section-title">Catalog</div></div>
        <a href="products.html" class="sidebar-link active"><i data-lucide="package"></i> Products</a>
        <a href="categories.html" class="sidebar-link"><i data-lucide="grid-3x3"></i> Categories</a>
        <div class="sidebar-section"><div class="sidebar-section-title">Business</div></div>
        <a href="orders.html" class="sidebar-link"><i data-lucide="shopping-bag"></i> Orders</a>
        <a href="coupons.html" class="sidebar-link"><i data-lucide="ticket"></i> Coupons</a>
      </nav>
    </aside>

    <main class="dashboard-content">
      <div class="page-header">
        <h2><i data-lucide="package" style="width:24px;height:24px;color:#8B5CF6;"></i> All Products</h2>
      </div>

      <!-- Status Tabs -->
      <div class="status-tabs" id="statusTabs">
        <button class="status-tab active" onclick="filterByStatus('all', this)">All <span class="tab-count" id="countAll">0</span></button>
        <button class="status-tab" onclick="filterByStatus('pending', this)">‚è≥ Pending <span class="tab-count" id="countPending">0</span></button>
        <button class="status-tab" onclick="filterByStatus('approved', this)">‚úÖ Approved <span class="tab-count" id="countApproved">0</span></button>
        <button class="status-tab" onclick="filterByStatus('rejected', this)">‚ùå Rejected <span class="tab-count" id="countRejected">0</span></button>
      </div>

      <div class="filter-bar">
        <input type="text" class="form-input" id="searchInput" placeholder="Search products by name or brand..." oninput="debounceSearch()">
      </div>

      <div class="products-table-wrap">
        <table class="products-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Seller</th>
              <th>Price</th>
              <th>Stock</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="productsBody">
            <tr><td colspan="6" class="empty-state"><p>Loading products...</p></td></tr>
          </tbody>
        </table>
      </div>

      <div class="pagination" id="pagination"></div>
    </main>
  </div>

  <script src="../../js/app.js"></script>
  <script>
    let currentPage = 1;
    let currentStatus = 'all';
    let searchQuery = '';
    let searchTimer = null;

    document.addEventListener('DOMContentLoaded', () => {
      const auth = getAuth();
      if (!auth || !auth.token) { window.location.href = '../auth/login.html'; return; }
      if (auth.user && auth.user.role !== 'admin') { window.location.href = '../../index.html'; return; }
      if (auth.user) {
        document.getElementById('navUserName').textContent = auth.user.name;
        document.getElementById('sidebarName').textContent = auth.user.name;
        document.getElementById('sidebarAvatar').textContent = auth.user.name.charAt(0).toUpperCase();
      }

      const dropdownBtn = document.getElementById('userDropdownBtn');
      const dropdownMenu = document.getElementById('userDropdownMenu');
      dropdownBtn.addEventListener('click', (e) => { e.stopPropagation(); dropdownMenu.classList.toggle('show'); });
      document.addEventListener('click', () => dropdownMenu.classList.remove('show'));

      loadProducts();
      lucide.createIcons();
    });

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
      const overlay = document.getElementById('sidebarOverlay');
      if (overlay) overlay.classList.toggle('active');
    }

    function debounceSearch() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => {
        searchQuery = document.getElementById('searchInput').value.trim();
        currentPage = 1;
        loadProducts();
      }, 400);
    }

    function filterByStatus(status, el) {
      currentStatus = status;
      currentPage = 1;
      document.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      loadProducts();
    }

    async function loadProducts() {
      let url = `/products/admin/all?page=${currentPage}&limit=15`;
      if (currentStatus !== 'all') url += `&status=${currentStatus}`;
      if (searchQuery) url += `&search=${encodeURIComponent(searchQuery)}`;

      const res = await apiCall(url);
      if (!res) return;

      const products = res.data || [];
      const tbody = document.getElementById('productsBody');

      // Update counts
      document.getElementById('countAll').textContent = res.total || 0;
      document.getElementById('countPending').textContent = res.pendingCount || 0;
      document.getElementById('countApproved').textContent = res.approvedCount || 0;
      document.getElementById('countRejected').textContent = res.rejectedCount || 0;

      if (products.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="empty-state"><p>No products found</p></td></tr>`;
        document.getElementById('pagination').innerHTML = '';
        return;
      }

      tbody.innerHTML = products.map(p => {
        const img = (p.images && p.images[0] && p.images[0].url) 
          ? p.images[0].url 
          : '';

        return `
          <tr>
            <td>
              <div class="product-cell">
                ${img ? `<img class="product-thumb" src="${img}" alt="${p.name}">` : '<div class="product-thumb" style="display:flex;align-items:center;justify-content:center;font-size:1.5rem;">üì¶</div>'}
                <div class="product-info">
                  <h4>${p.name.length > 30 ? p.name.substring(0, 30) + '...' : p.name}</h4>
                  <p>${p.category ? p.category.name : '-'} ¬∑ ${p.brand || 'No brand'}</p>
                </div>
              </div>
            </td>
            <td>
              <div style="font-weight:500;">${p.seller ? p.seller.name : '-'}</div>
              <div style="font-size:0.75rem;color:var(--muted);">${p.sellerProfile ? p.sellerProfile.storeName : ''}</div>
            </td>
            <td>
              <div style="font-weight:600;">‚Çπ${p.price.toLocaleString('en-IN')}</div>
            </td>
            <td><span style="font-weight:600;${p.stock < 5 ? 'color:#DC2626;' : ''}">${p.stock}</span></td>
            <td><span class="status-badge ${p.isApproved}">${p.isApproved}</span></td>
            <td>
              <div class="action-btns">
                ${p.isApproved === 'pending' ? `
                  <button class="approve-btn" onclick="updateApproval('${p._id}', 'approved')" title="Approve">‚úì Approve</button>
                  <button class="reject-btn" onclick="updateApproval('${p._id}', 'rejected')" title="Reject">‚úó Reject</button>
                ` : p.isApproved === 'rejected' ? `
                  <button class="approve-btn" onclick="updateApproval('${p._id}', 'approved')" title="Approve">‚úì Approve</button>
                ` : `
                  <button class="reject-btn" onclick="updateApproval('${p._id}', 'rejected')" title="Reject">‚úó Reject</button>
                `}
                <button class="featured-btn ${p.isFeatured ? 'is-featured' : ''}" onclick="toggleFeatured('${p._id}')" title="${p.isFeatured ? 'Remove from featured' : 'Mark as featured'}">
                  ‚òÖ
                </button>
              </div>
            </td>
          </tr>`;
      }).join('');

      renderPagination(res.pages, res.currentPage);
      lucide.createIcons();
    }

    function renderPagination(totalPages, current) {
      const pag = document.getElementById('pagination');
      if (totalPages <= 1) { pag.innerHTML = ''; return; }
      let html = `<button ${current === 1 ? 'disabled' : ''} onclick="goToPage(${current - 1})">‚Äπ</button>`;
      for (let i = 1; i <= totalPages; i++) {
        if (i === current || i === 1 || i === totalPages || (i >= current - 1 && i <= current + 1)) {
          html += `<button class="${i === current ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
        } else if (i === current - 2 || i === current + 2) {
          html += `<button disabled>...</button>`;
        }
      }
      html += `<button ${current === totalPages ? 'disabled' : ''} onclick="goToPage(${current + 1})">‚Ä∫</button>`;
      pag.innerHTML = html;
    }

    function goToPage(page) { currentPage = page; loadProducts(); }

    async function updateApproval(id, status) {
      const res = await apiCall(`/products/admin/${id}/approval`, 'PUT', { status });
      if (res && res.success) {
        showToast(`Product ${status}`, 'success');
        loadProducts();
      } else if (res) {
        showToast(res.message || 'Failed', 'error');
      }
    }

    async function toggleFeatured(id) {
      const res = await apiCall(`/products/admin/${id}/featured`, 'PUT', {});
      if (res && res.success) {
        showToast(res.message, 'success');
        loadProducts();
      }
    }
  </script>
<button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
</body>
</html>
