<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Products - Seller | Dealify</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EüõçÔ∏è%3C/text%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="stylesheet" href="../../css/components.css">
  <link rel="stylesheet" href="../../css/dashboard.css">
  <link rel="stylesheet" href="../../css/responsive.css">
  <style>
    body { font-family: 'Inter', var(--font-family); }
    .navbar { background: linear-gradient(135deg, #D97706, #F59E0B) !important; }
    .navbar .navbar-logo, .navbar .navbar-logo span { color: #fff !important; }
    .navbar .navbar-link, .navbar .navbar-link span { color: #fff !important; }
    .seller-badge { background: rgba(255,255,255,0.25); color: white; padding: 4px 14px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px; border: 1px solid rgba(255,255,255,0.4); }
    .dashboard-sidebar { border-right: 3px solid #F59E0B; }
    .sidebar-header { background: linear-gradient(135deg, #FFFBEB, #FEF3C7); border-bottom: 1px solid #FDE68A; }
    .sidebar-link.active { background: #FFFBEB; color: #D97706 !important; border-left: 3px solid #D97706; }

    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xl); flex-wrap: wrap; gap: var(--space-md); }
    .page-header h2 { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }

    /* Filter Bar */
    .filter-bar { display: flex; gap: var(--space-md); margin-bottom: var(--space-xl); flex-wrap: wrap; align-items: center; }
    .filter-bar .form-input { max-width: 250px; }
    .filter-bar select { max-width: 180px; }

    /* Status Tabs */
    .status-tabs { display: flex; gap: 4px; background: var(--bg); padding: 4px; border-radius: var(--radius-md); margin-bottom: var(--space-xl); overflow-x: auto; }
    .status-tab { padding: 8px 16px; border-radius: var(--radius-sm); font-size: 0.85rem; font-weight: 500; cursor: pointer; white-space: nowrap; border: none; background: transparent; color: var(--text-secondary); transition: 0.2s; }
    .status-tab.active { background: var(--card-bg); color: var(--text-primary); box-shadow: var(--shadow-sm); font-weight: 600; }
    .status-tab .tab-count { background: var(--border); padding: 1px 8px; border-radius: 10px; font-size: 0.7rem; margin-left: 4px; }
    .status-tab.active .tab-count { background: #D97706; color: #fff; }

    /* Product Table */
    .products-table-wrap { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
    .products-table { width: 100%; border-collapse: collapse; }
    .products-table thead { background: var(--bg); }
    .products-table th { padding: 12px 16px; text-align: left; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--muted); letter-spacing: 0.5px; }
    .products-table td { padding: 12px 16px; border-top: 1px solid var(--border); font-size: 0.9rem; vertical-align: middle; }
    .products-table tr:hover { background: var(--bg); }

    .product-cell { display: flex; align-items: center; gap: 12px; }
    .product-thumb { width: 50px; height: 50px; border-radius: var(--radius-sm); object-fit: cover; background: var(--bg); flex-shrink: 0; }
    .product-info h4 { font-weight: 600; font-size: 0.9rem; margin-bottom: 2px; }
    .product-info p { color: var(--muted); font-size: 0.75rem; }

    .status-badge { padding: 3px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; }
    .status-badge.pending { background: #FEF3C7; color: #92400E; }
    .status-badge.approved { background: #D1FAE5; color: #065F46; }
    .status-badge.rejected { background: #FEE2E2; color: #991B1B; }
    .status-badge.inactive { background: #F1F5F9; color: #64748B; }

    .action-btns { display: flex; gap: 4px; }
    .action-btns button { background: none; border: none; cursor: pointer; padding: 6px; border-radius: var(--radius-sm); color: var(--muted); transition: 0.2s; }
    .action-btns button:hover { background: var(--bg); color: var(--text-primary); }
    .action-btns button.delete-btn:hover { background: #FEE2E2; color: #DC2626; }

    .empty-state { text-align: center; padding: 3rem; color: var(--muted); }
    .empty-state .icon { font-size: 3rem; margin-bottom: 1rem; }

    /* Pagination */
    .pagination { display: flex; justify-content: center; gap: 4px; margin-top: var(--space-xl); }
    .pagination button { padding: 8px 14px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--card-bg); cursor: pointer; font-size: 0.85rem; }
    .pagination button.active { background: #D97706; color: #fff; border-color: #D97706; }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: var(--space-lg); }
    .modal-overlay.show { display: flex; }
    .modal { background: var(--card-bg); border-radius: var(--radius-xl); padding: 0; width: 100%; max-width: 400px; box-shadow: var(--shadow-xl); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: var(--space-lg) var(--space-xl); border-bottom: 1px solid var(--border); }
    .modal-header h3 { font-size: 1.1rem; font-weight: 700; }
    .modal-close { background: none; border: none; cursor: pointer; padding: 6px; border-radius: var(--radius-sm); color: var(--muted); }
    .modal-body { padding: var(--space-xl); text-align: center; }
    .modal-footer { display: flex; justify-content: flex-end; gap: var(--space-sm); padding: var(--space-lg) var(--space-xl); border-top: 1px solid var(--border); background: var(--bg); border-radius: 0 0 var(--radius-xl) var(--radius-xl); }

    @media (max-width: 768px) {
      .page-header { flex-direction: column; align-items: stretch; }
      .filter-bar { flex-direction: column; }
      .filter-bar .form-input, .filter-bar select { max-width: 100%; }
      .products-table th:nth-child(n+4), .products-table td:nth-child(n+4) { display: none; }
    }
  </style>
</head>
<body>

  <div class="seller-role-strip">üè™ SELLER ACCOUNT</div>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-inner">
      <a href="../../index.html" class="navbar-logo">Deal<span>ify</span></a>
      <div style="flex:1;"></div>
      <div class="navbar-actions">
        <span class="seller-badge">SELLER</span>
        <div class="user-dropdown">
          <button class="navbar-link" id="userDropdownBtn">
            <i data-lucide="user"></i>
            <span id="navUserName">Seller</span>
          </button>
          <div class="user-dropdown-menu" id="userDropdownMenu">
            <a href="dashboard.html"><i data-lucide="layout-dashboard" style="width:16px;height:16px;"></i> Dashboard</a>
            <a href="products.html"><i data-lucide="package" style="width:16px;height:16px;"></i> Products</a>
            <div class="user-dropdown-divider"></div>
            <button onclick="logout()"><i data-lucide="log-out" style="width:16px;height:16px;"></i> Logout</button>
          </div>
        </div>
      </div>
      <div class="hamburger" onclick="toggleSidebar()">
        <span></span><span></span><span></span>
      </div>
    </div>
  </nav>

  <div class="toast-container" id="toastContainer"></div>

  <div class="dashboard-wrapper">
    <!-- Sidebar -->
    <aside class="dashboard-sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-avatar" id="sidebarAvatar" style="background:#FED7AA;color:#EA580C;">S</div>
        <div class="sidebar-user-info">
          <h4 id="sidebarStoreName">Store Name</h4>
          <p id="sidebarApproval" class="badge badge-warning" style="font-size:0.6rem;">Pending</p>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="sidebar-section"><div class="sidebar-section-title">Overview</div></div>
        <a href="dashboard.html" class="sidebar-link"><i data-lucide="layout-dashboard"></i> Dashboard</a>

        <div class="sidebar-section"><div class="sidebar-section-title">Products</div></div>
        <a href="products.html" class="sidebar-link active"><i data-lucide="package"></i> All Products</a>
        <a href="add-product.html" class="sidebar-link"><i data-lucide="plus-circle"></i> Add Product</a>

        <div class="sidebar-section"><div class="sidebar-section-title">Orders</div></div>
        <a href="orders.html" class="sidebar-link"><i data-lucide="shopping-bag"></i> Orders</a>

        <div class="sidebar-section"><div class="sidebar-section-title">Financial</div></div>
        <a href="earnings.html" class="sidebar-link"><i data-lucide="indian-rupee"></i> Earnings</a>

        <div class="sidebar-section"><div class="sidebar-section-title">Account</div></div>
        <a href="profile.html" class="sidebar-link"><i data-lucide="store"></i> Store Profile</a>
        <a href="reviews.html" class="sidebar-link"><i data-lucide="star"></i> Reviews</a>
        <a href="#" class="sidebar-link" onclick="logout()"><i data-lucide="log-out"></i> Logout</a>
      </nav>
    </aside>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <main class="dashboard-content">
      <div class="page-header">
        <h2><i data-lucide="package" style="width:24px;height:24px;color:#D97706;"></i> My Products</h2>
        <a href="add-product.html" class="btn btn-primary">
          <i data-lucide="plus" style="width:18px;height:18px;"></i> Add Product
        </a>
      </div>

      <!-- Status Tabs -->
      <div class="status-tabs" id="statusTabs">
        <button class="status-tab active" onclick="filterByStatus('all', this)">All <span class="tab-count" id="countAll">0</span></button>
        <button class="status-tab" onclick="filterByStatus('pending', this)">Pending <span class="tab-count" id="countPending">0</span></button>
        <button class="status-tab" onclick="filterByStatus('approved', this)">Approved <span class="tab-count" id="countApproved">0</span></button>
        <button class="status-tab" onclick="filterByStatus('rejected', this)">Rejected <span class="tab-count" id="countRejected">0</span></button>
        <button class="status-tab" onclick="filterByStatus('inactive', this)">Inactive <span class="tab-count" id="countInactive">0</span></button>
      </div>

      <!-- Search -->
      <div class="filter-bar">
        <input type="text" class="form-input" id="searchInput" placeholder="Search products..." oninput="debounceSearch()">
      </div>

      <!-- Products Table -->
      <div class="products-table-wrap">
        <table class="products-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Price</th>
              <th>Stock</th>
              <th>Category</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="productsBody">
            <tr><td colspan="6" class="empty-state"><div class="icon">üì¶</div><p>Loading products...</p></td></tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination" id="pagination"></div>
    </main>
  </div>

  <!-- Delete Modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Delete Product</h3>
        <button class="modal-close" onclick="closeDeleteModal()"><i data-lucide="x" style="width:20px;height:20px;"></i></button>
      </div>
      <div class="modal-body">
        <div style="font-size:3rem;margin-bottom:var(--space-md);">üóëÔ∏è</div>
        <p style="font-weight:600;margin-bottom:4px;" id="deleteName"></p>
        <p style="color:var(--muted);font-size:0.85rem;">This will permanently remove this product. This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn" style="background:#DC2626;color:#fff;" onclick="confirmDelete()">
          <i data-lucide="trash-2" style="width:16px;height:16px;"></i> Delete
        </button>
      </div>
    </div>
  </div>

  <script src="../../js/app.js"></script>
  <script>
    let currentPage = 1;
    let currentStatus = 'all';
    let searchQuery = '';
    let deleteTargetId = null;
    let searchTimer = null;

    document.addEventListener('DOMContentLoaded', () => {
      const auth = getAuth();
      if (!auth || !auth.token) { window.location.href = '../auth/login.html'; return; }
      if (auth.user && auth.user.role !== 'seller') { window.location.href = '../../index.html'; return; }
      if (auth.user) {
        document.getElementById('navUserName').textContent = auth.user.name;
        document.getElementById('sidebarAvatar').textContent = auth.user.name.charAt(0).toUpperCase();
      }

      const dropdownBtn = document.getElementById('userDropdownBtn');
      const dropdownMenu = document.getElementById('userDropdownMenu');
      dropdownBtn.addEventListener('click', (e) => { e.stopPropagation(); dropdownMenu.classList.toggle('show'); });
      document.addEventListener('click', () => dropdownMenu.classList.remove('show'));

      loadSellerProfile();
      loadProducts();
      lucide.createIcons();
    });

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
      const overlay = document.getElementById('sidebarOverlay');
      if (overlay) overlay.classList.toggle('active');
    }

    async function loadSellerProfile() {
      const res = await apiCall('/sellers/profile');
      if (res && res.data) {
        document.getElementById('sidebarStoreName').textContent = res.data.storeName || 'My Store';
        if (res.data.isApproved === 'approved') {
          document.getElementById('sidebarApproval').textContent = 'Approved';
          document.getElementById('sidebarApproval').className = 'badge badge-success';
        }
      }
    }

    function debounceSearch() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => {
        searchQuery = document.getElementById('searchInput').value.trim();
        currentPage = 1;
        loadProducts();
      }, 400);
    }

    function filterByStatus(status, el) {
      currentStatus = status;
      currentPage = 1;
      document.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      loadProducts();
    }

    async function loadProducts() {
      let url = `/products/my-products?page=${currentPage}&limit=10`;
      if (currentStatus !== 'all') url += `&status=${currentStatus}`;
      if (searchQuery) url += `&search=${encodeURIComponent(searchQuery)}`;

      const res = await apiCall(url);
      if (!res) return;

      const products = res.data || [];
      const tbody = document.getElementById('productsBody');

      // Update counts
      document.getElementById('countAll').textContent = res.total || 0;

      if (products.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="6" class="empty-state">
            <div class="icon">üì¶</div>
            <p style="font-weight:600;">No products found</p>
            <p style="font-size:0.85rem;">Try adjusting your filters or <a href="add-product.html" style="color:#D97706;font-weight:600;">add a new product</a>.</p>
          </td></tr>`;
        document.getElementById('pagination').innerHTML = '';
        return;
      }

      tbody.innerHTML = products.map(p => {
        const img = (p.images && p.images[0] && p.images[0].url) 
          ? p.images[0].url 
          : `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23f1f5f9' width='100' height='100'/><text x='50' y='50' text-anchor='middle' dy='.35em' fill='%2394a3b8' font-size='30'>üì¶</text></svg>`;
        
        let statusClass = p.isApproved;
        if (!p.isActive) statusClass = 'inactive';
        let statusText = p.isApproved.charAt(0).toUpperCase() + p.isApproved.slice(1);
        if (!p.isActive) statusText = 'Inactive';

        const discount = p.mrp > p.price ? Math.round(((p.mrp - p.price) / p.mrp) * 100) : 0;

        return `
          <tr>
            <td>
              <div class="product-cell">
                <img class="product-thumb" src="${img}" alt="${p.name}" onerror="this.style.background='#f1f5f9'">
                <div class="product-info">
                  <h4>${p.name.length > 35 ? p.name.substring(0, 35) + '...' : p.name}</h4>
                  <p>${p.brand || 'No brand'} ¬∑ SKU: ${p.sku || 'N/A'}</p>
                </div>
              </div>
            </td>
            <td>
              <div style="font-weight:600;">‚Çπ${p.price.toLocaleString('en-IN')}</div>
              ${discount > 0 ? `<div style="font-size:0.75rem;"><span style="text-decoration:line-through;color:var(--muted);">‚Çπ${p.mrp.toLocaleString('en-IN')}</span> <span style="color:#16A34A;font-weight:600;">${discount}% off</span></div>` : ''}
            </td>
            <td>
              <span style="font-weight:600;${p.stock < 5 ? 'color:#DC2626;' : ''}">${p.stock}</span>
              ${p.stock < 5 ? '<br><span style="font-size:0.7rem;color:#DC2626;">Low stock!</span>' : ''}
            </td>
            <td>${p.category ? `${p.category.name}` : '-'}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>
              <div class="action-btns">
                <button title="Edit" onclick="editProduct('${p._id}')">
                  <i data-lucide="pencil" style="width:16px;height:16px;"></i>
                </button>
                <button title="Toggle Active" onclick="toggleActive('${p._id}', ${p.isActive})">
                  <i data-lucide="${p.isActive ? 'eye' : 'eye-off'}" style="width:16px;height:16px;"></i>
                </button>
                <button class="delete-btn" title="Delete" onclick="deleteProduct('${p._id}', '${p.name.replace(/'/g, "\\'")}')">
                  <i data-lucide="trash-2" style="width:16px;height:16px;"></i>
                </button>
              </div>
            </td>
          </tr>`;
      }).join('');

      // Pagination
      renderPagination(res.pages, res.currentPage);
      lucide.createIcons();
    }

    function renderPagination(totalPages, current) {
      const pag = document.getElementById('pagination');
      if (totalPages <= 1) { pag.innerHTML = ''; return; }
      let html = '';
      html += `<button ${current === 1 ? 'disabled' : ''} onclick="goToPage(${current - 1})">‚Äπ</button>`;
      for (let i = 1; i <= totalPages; i++) {
        if (i === current || i === 1 || i === totalPages || (i >= current - 1 && i <= current + 1)) {
          html += `<button class="${i === current ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
        } else if (i === current - 2 || i === current + 2) {
          html += `<button disabled>...</button>`;
        }
      }
      html += `<button ${current === totalPages ? 'disabled' : ''} onclick="goToPage(${current + 1})">‚Ä∫</button>`;
      pag.innerHTML = html;
    }

    function goToPage(page) {
      currentPage = page;
      loadProducts();
    }

    function editProduct(id) {
      window.location.href = `add-product.html?id=${id}`;
    }

    async function toggleActive(id, currentState) {
      const res = await apiCall(`/products/${id}`, 'PUT', { isActive: !currentState });
      if (res && res.success) {
        showToast(currentState ? 'Product deactivated' : 'Product activated', 'success');
        loadProducts();
      }
    }

    function deleteProduct(id, name) {
      deleteTargetId = id;
      document.getElementById('deleteName').textContent = name;
      document.getElementById('deleteModal').classList.add('show');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('show');
      deleteTargetId = null;
    }

    async function confirmDelete() {
      if (!deleteTargetId) return;
      const res = await apiCall(`/products/${deleteTargetId}`, 'DELETE');
      if (res && res.success) {
        showToast('Product deleted', 'success');
        closeDeleteModal();
        loadProducts();
      } else if (res) {
        showToast(res.message || 'Failed to delete', 'error');
      }
    }
  </script>
<button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
</body>
</html>
