<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Product - Seller | Dealify</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EüõçÔ∏è%3C/text%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <link rel="stylesheet" href="../../css/style.css">
  <link rel="stylesheet" href="../../css/components.css">
  <link rel="stylesheet" href="../../css/dashboard.css">
  <link rel="stylesheet" href="../../css/responsive.css">
  <style>
    body { font-family: 'Inter', var(--font-family); }
    .navbar { background: linear-gradient(135deg, #D97706, #F59E0B) !important; }
    .navbar .navbar-logo, .navbar .navbar-logo span { color: #fff !important; }
    .navbar .navbar-link, .navbar .navbar-link span { color: #fff !important; }
    .seller-badge { background: rgba(255,255,255,0.25); color: white; padding: 4px 14px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.5px; border: 1px solid rgba(255,255,255,0.4); }
    .dashboard-sidebar { border-right: 3px solid #F59E0B; }
    .sidebar-header { background: linear-gradient(135deg, #FFFBEB, #FEF3C7); border-bottom: 1px solid #FDE68A; }
    .sidebar-link.active { background: #FFFBEB; color: #D97706 !important; border-left: 3px solid #D97706; }

    /* Form Layout */
    .form-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: var(--space-xl); margin-bottom: var(--space-xl); }
    .form-card-title { font-size: 1.1rem; font-weight: 700; margin-bottom: var(--space-lg); display: flex; align-items: center; gap: 8px; padding-bottom: var(--space-md); border-bottom: 1px solid var(--border); }
    .form-card-title i { color: #D97706; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg); }
    .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--space-lg); }

    .image-upload-area { border: 2px dashed var(--border); border-radius: var(--radius-lg); padding: var(--space-2xl); text-align: center; cursor: pointer; transition: 0.3s; background: var(--bg); }
    .image-upload-area:hover { border-color: #D97706; background: #FFFBEB; }
    .image-upload-area i { color: var(--muted); }
    .image-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: var(--space-md); margin-top: var(--space-md); }
    .image-preview { position: relative; border-radius: var(--radius-md); overflow: hidden; aspect-ratio: 1; }
    .image-preview img { width: 100%; height: 100%; object-fit: cover; }
    .image-preview .remove-img { position: absolute; top: 4px; right: 4px; background: rgba(220,38,38,0.9); color: #fff; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }

    .spec-row { display: flex; gap: var(--space-sm); margin-bottom: var(--space-sm); align-items: center; }
    .spec-row input { flex: 1; }
    .spec-row button { flex-shrink: 0; }

    .size-chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .size-chip { padding: 6px 16px; border: 2px solid var(--border); border-radius: var(--radius-md); cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: 0.2s; background: var(--card-bg); }
    .size-chip.active { border-color: #D97706; background: #FFFBEB; color: #D97706; }

    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xl); flex-wrap: wrap; gap: var(--space-md); }
    .form-actions { display: flex; justify-content: flex-end; gap: var(--space-md); padding-top: var(--space-xl); border-top: 1px solid var(--border); margin-top: var(--space-xl); }

    .price-preview { background: linear-gradient(135deg, #FFFBEB, #FEF3C7); padding: var(--space-lg); border-radius: var(--radius-md); margin-top: var(--space-md); }
    .price-preview .sale-price { font-size: 1.5rem; font-weight: 800; color: #D97706; }
    .price-preview .mrp-price { font-size: 0.9rem; text-decoration: line-through; color: var(--muted); margin-left: 8px; }
    .price-preview .discount { font-size: 0.85rem; color: #16A34A; font-weight: 600; margin-left: 8px; }

    @media (max-width: 768px) {
      .form-row, .form-row-3 { grid-template-columns: 1fr; }
      .page-header { flex-direction: column; align-items: stretch; }
    }
  </style>
</head>
<body>

  <div class="seller-role-strip">üè™ SELLER ACCOUNT</div>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-inner">
      <a href="../../index.html" class="navbar-logo">Deal<span>ify</span></a>
      <div style="flex:1;"></div>
      <div class="navbar-actions">
        <span class="seller-badge">SELLER</span>
        <div class="user-dropdown">
          <button class="navbar-link" id="userDropdownBtn">
            <i data-lucide="user"></i>
            <span id="navUserName">Seller</span>
          </button>
          <div class="user-dropdown-menu" id="userDropdownMenu">
            <a href="dashboard.html"><i data-lucide="layout-dashboard" style="width:16px;height:16px;"></i> Dashboard</a>
            <a href="products.html"><i data-lucide="package" style="width:16px;height:16px;"></i> Products</a>
            <div class="user-dropdown-divider"></div>
            <button onclick="logout()"><i data-lucide="log-out" style="width:16px;height:16px;"></i> Logout</button>
          </div>
        </div>
      </div>
      <div class="hamburger" onclick="toggleSidebar()">
        <span></span><span></span><span></span>
      </div>
    </div>
  </nav>

  <div class="toast-container" id="toastContainer"></div>

  <!-- Dashboard Layout -->
  <div class="dashboard-wrapper">
    
    <!-- Sidebar -->
    <aside class="dashboard-sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-avatar" id="sidebarAvatar" style="background:#FED7AA;color:#EA580C;">S</div>
        <div class="sidebar-user-info">
          <h4 id="sidebarStoreName">Store Name</h4>
          <p id="sidebarApproval" class="badge badge-warning" style="font-size:0.6rem;">Pending</p>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="sidebar-section"><div class="sidebar-section-title">Overview</div></div>
        <a href="dashboard.html" class="sidebar-link"><i data-lucide="layout-dashboard"></i> Dashboard</a>

        <div class="sidebar-section"><div class="sidebar-section-title">Products</div></div>
        <a href="products.html" class="sidebar-link"><i data-lucide="package"></i> All Products</a>
        <a href="add-product.html" class="sidebar-link active"><i data-lucide="plus-circle"></i> Add Product</a>

        <div class="sidebar-section"><div class="sidebar-section-title">Orders</div></div>
        <a href="orders.html" class="sidebar-link"><i data-lucide="shopping-bag"></i> Orders</a>

        <div class="sidebar-section"><div class="sidebar-section-title">Financial</div></div>
        <a href="earnings.html" class="sidebar-link"><i data-lucide="indian-rupee"></i> Earnings</a>

        <div class="sidebar-section"><div class="sidebar-section-title">Account</div></div>
        <a href="profile.html" class="sidebar-link"><i data-lucide="store"></i> Store Profile</a>
        <a href="reviews.html" class="sidebar-link"><i data-lucide="star"></i> Reviews</a>
        <a href="#" class="sidebar-link" onclick="logout()"><i data-lucide="log-out"></i> Logout</a>
      </nav>
    </aside>

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <main class="dashboard-content">

      <div class="page-header">
        <div>
          <h1 id="formTitle" style="font-size:1.5rem;font-weight:700;display:flex;align-items:center;gap:8px;">
            <i id="formTitleIcon" data-lucide="plus-circle" style="width:24px;height:24px;color:#D97706;"></i> Add New Product
          </h1>
          <p id="formSubtitle" style="color:var(--muted);font-size:0.85rem;margin-top:4px;">Fill in the details to list your product on Dealify</p>
        </div>
        <a href="products.html" class="btn btn-ghost"><i data-lucide="arrow-left" style="width:16px;height:16px;"></i> Back to Products</a>
      </div>

      <form id="productForm">

        <!-- Basic Info -->
        <div class="form-card">
          <div class="form-card-title"><i data-lucide="info" style="width:20px;height:20px;"></i> Basic Information</div>
          
          <div class="form-group" style="margin-bottom:var(--space-lg);">
            <label class="form-label">Product Name *</label>
            <input type="text" id="prodName" class="form-input" placeholder="e.g. Premium Wireless Earbuds" required>
          </div>

          <div class="form-group" style="margin-bottom:var(--space-lg);">
            <label class="form-label">Short Description</label>
            <input type="text" id="prodShortDesc" class="form-input" placeholder="A quick summary (shown in listings)" maxlength="200">
          </div>

          <div class="form-group" style="margin-bottom:var(--space-lg);">
            <label class="form-label">Full Description</label>
            <textarea id="prodDescription" class="form-input" rows="5" placeholder="Detailed product description..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Category *</label>
              <select id="prodCategory" class="form-input" required>
                <option value="">Select category</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Brand</label>
              <input type="text" id="prodBrand" class="form-input" placeholder="e.g. Samsung, Nike">
            </div>
          </div>
        </div>

        <!-- Pricing -->
        <div class="form-card">
          <div class="form-card-title"><i data-lucide="indian-rupee" style="width:20px;height:20px;"></i> Pricing</div>

          <div class="form-row-3">
            <div class="form-group">
              <label class="form-label">Selling Price (‚Çπ) *</label>
              <input type="number" id="prodPrice" class="form-input" placeholder="499" min="1" required oninput="updatePricePreview()">
            </div>
            <div class="form-group">
              <label class="form-label">MRP (‚Çπ)</label>
              <input type="number" id="prodMRP" class="form-input" placeholder="999" min="0" oninput="updatePricePreview()">
            </div>
            <div class="form-group">
              <label class="form-label">Stock Quantity *</label>
              <input type="number" id="prodStock" class="form-input" placeholder="100" min="0" required>
            </div>
          </div>

          <div class="price-preview" id="pricePreview" style="display:none;">
            <span style="font-size:0.75rem;color:var(--muted);text-transform:uppercase;font-weight:600;">Preview:</span><br>
            <span class="sale-price" id="previewPrice">‚Çπ0</span>
            <span class="mrp-price" id="previewMRP"></span>
            <span class="discount" id="previewDiscount"></span>
          </div>
        </div>

        <!-- Images -->
        <div class="form-card">
          <div class="form-card-title"><i data-lucide="image" style="width:20px;height:20px;"></i> Product Images</div>

          <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('imageFileInput').click()">
            <i data-lucide="upload-cloud" style="width:48px;height:48px;margin-bottom:12px;display:block;margin-left:auto;margin-right:auto;"></i>
            <p style="font-weight:600;margin-bottom:4px;">Click to upload or drag & drop</p>
            <p style="font-size:0.8rem;color:var(--muted);">PNG, JPG, WEBP up to 5MB each (max 5 images)</p>
            <input type="file" id="imageFileInput" accept="image/*" multiple style="display:none;" onchange="handleImageFiles(this.files)">
          </div>
          <div id="uploadProgress" style="display:none;margin-top:12px;">
            <div style="background:var(--border);border-radius:8px;height:6px;overflow:hidden;">
              <div id="uploadBar" style="background:#D97706;height:100%;width:0%;transition:width 0.3s;border-radius:8px;"></div>
            </div>
            <p id="uploadStatus" style="font-size:0.8rem;color:var(--muted);margin-top:4px;">Uploading...</p>
          </div>

          <div class="image-preview-grid" id="imagePreviewGrid"></div>
        </div>

        <!-- Variants & Sizes -->
        <div class="form-card">
          <div class="form-card-title"><i data-lucide="palette" style="width:20px;height:20px;"></i> Variants & Options</div>

          <div class="form-group" style="margin-bottom:var(--space-xl);">
            <label class="form-label">Sizes (click to select)</label>
            <div class="size-chips" id="sizeChips">
              <span class="size-chip" onclick="toggleSize(this)" data-size="XS">XS</span>
              <span class="size-chip" onclick="toggleSize(this)" data-size="S">S</span>
              <span class="size-chip" onclick="toggleSize(this)" data-size="M">M</span>
              <span class="size-chip" onclick="toggleSize(this)" data-size="L">L</span>
              <span class="size-chip" onclick="toggleSize(this)" data-size="XL">XL</span>
              <span class="size-chip" onclick="toggleSize(this)" data-size="XXL">XXL</span>
              <span class="size-chip" onclick="toggleSize(this)" data-size="Free Size">Free Size</span>
              <span class="size-chip" onclick="toggleSize(this)" data-size="28">28</span>
              <span class="size-chip" onclick="toggleSize(this)" data-size="30">30</span>
              <span class="size-chip" onclick="toggleSize(this)" data-size="32">32</span>
              <span class="size-chip" onclick="toggleSize(this)" data-size="34">34</span>
              <span class="size-chip" onclick="toggleSize(this)" data-size="36">36</span>
              <span class="size-chip" onclick="toggleSize(this)" data-size="38">38</span>
              <span class="size-chip" onclick="toggleSize(this)" data-size="40">40</span>
              <span class="size-chip" onclick="toggleSize(this)" data-size="42">42</span>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Tags (comma separated)</label>
            <input type="text" id="prodTags" class="form-input" placeholder="wireless, bluetooth, earbuds, music">
          </div>
        </div>

        <!-- Specifications -->
        <div class="form-card">
          <div class="form-card-title"><i data-lucide="list" style="width:20px;height:20px;"></i> Specifications</div>
          
          <div id="specsContainer">
            <div class="spec-row">
              <input type="text" class="form-input spec-key" placeholder="Specification (e.g. Weight)">
              <input type="text" class="form-input spec-val" placeholder="Value (e.g. 250g)">
              <button type="button" class="btn btn-ghost" onclick="removeSpec(this)" style="padding:8px;">
                <i data-lucide="x" style="width:16px;height:16px;"></i>
              </button>
            </div>
          </div>
          <button type="button" class="btn btn-ghost" onclick="addSpec()" style="margin-top:var(--space-sm);">
            <i data-lucide="plus" style="width:16px;height:16px;"></i> Add Specification
          </button>
        </div>

        <!-- Shipping -->
        <div class="form-card">
          <div class="form-card-title"><i data-lucide="truck" style="width:20px;height:20px;"></i> Shipping & Returns</div>

          <div class="form-row-3">
            <div class="form-group">
              <label class="form-label">Weight (grams)</label>
              <input type="number" id="prodWeight" class="form-input" placeholder="500" min="0">
            </div>
            <div class="form-group">
              <label class="form-label">Shipping Cost (‚Çπ)</label>
              <input type="number" id="shippingCost" class="form-input" placeholder="0 = Free" min="0">
            </div>
            <div class="form-group">
              <label class="form-label">Estimated Days</label>
              <input type="number" id="shippingDays" class="form-input" placeholder="5" min="1">
            </div>
          </div>

          <div class="form-row" style="margin-top:var(--space-lg);">
            <div class="form-group">
              <label class="form-label">Returnable?</label>
              <select id="returnable" class="form-input">
                <option value="true">Yes, returnable</option>
                <option value="false">Non-returnable</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Return Window (days)</label>
              <input type="number" id="returnDays" class="form-input" placeholder="7" min="1" value="7">
            </div>
          </div>

          <div class="form-group" style="margin-top:var(--space-lg);">
            <label class="form-label">SKU (optional)</label>
            <input type="text" id="prodSKU" class="form-input" placeholder="DLF-ELEC-001">
          </div>
        </div>

        <!-- Submit -->
        <div class="form-actions">
          <a href="products.html" class="btn btn-ghost">Cancel</a>
          <button type="submit" class="btn btn-primary" id="submitBtn">
            <i data-lucide="check" style="width:18px;height:18px;"></i> Submit Product
          </button>
        </div>
      </form>

    </main>
  </div>

  <script src="../../js/app.js"></script>
  <script>
    let selectedSizes = [];
    let uploadedImages = []; // { url, public_id }
    let editProductId = null;

    document.addEventListener('DOMContentLoaded', async () => {
      const auth = getAuth();
      if (!auth || !auth.token) { window.location.href = '../auth/login.html'; return; }
      if (auth.user && auth.user.role !== 'seller') { window.location.href = '../../index.html'; return; }
      if (auth.user) {
        document.getElementById('navUserName').textContent = auth.user.name;
        document.getElementById('sidebarAvatar').textContent = auth.user.name.charAt(0).toUpperCase();
      }

      // Dropdown
      const dropdownBtn = document.getElementById('userDropdownBtn');
      const dropdownMenu = document.getElementById('userDropdownMenu');
      dropdownBtn.addEventListener('click', (e) => { e.stopPropagation(); dropdownMenu.classList.toggle('show'); });
      document.addEventListener('click', () => dropdownMenu.classList.remove('show'));

      await loadCategories();
      await loadSellerProfile();

      const params = new URLSearchParams(window.location.search);
      editProductId = params.get('id');
      if (editProductId) {
        setEditModeUI();
        await loadProductForEdit(editProductId);
      }

      lucide.createIcons();
    });

    function setEditModeUI() {
      document.title = 'Edit Product - Seller | Dealify';
      document.getElementById('formTitle').innerHTML = '<i id="formTitleIcon" data-lucide="pencil" style="width:24px;height:24px;color:#D97706;"></i> Edit Product';
      document.getElementById('formSubtitle').textContent = 'Update details and save changes to your product';
      document.getElementById('submitBtn').innerHTML = '<i data-lucide="save" style="width:18px;height:18px;"></i> Save Changes';
    }

    async function loadProductForEdit(id) {
      let product = null;

      const directRes = await apiCall(`/products/my-products/${id}`);
      if (directRes && directRes.success && directRes.data) {
        product = directRes.data;
      } else {
        const listRes = await apiCall('/products/my-products?page=1&limit=100');
        if (listRes && listRes.success && Array.isArray(listRes.data)) {
          product = listRes.data.find((p) => String(p._id) === String(id)) || null;
        }
      }

      if (!product) {
        showToast('Unable to load product for editing', 'error');
        setTimeout(() => { window.location.href = 'products.html'; }, 1200);
        return;
      }

      document.getElementById('prodName').value = product.name || '';
      document.getElementById('prodShortDesc').value = product.shortDescription || '';
      document.getElementById('prodDescription').value = product.description || '';
      document.getElementById('prodCategory').value = product.category?._id || '';
      document.getElementById('prodBrand').value = product.brand || '';
      document.getElementById('prodPrice').value = product.price || '';
      document.getElementById('prodMRP').value = product.mrp || '';
      document.getElementById('prodStock').value = product.stock ?? 0;
      document.getElementById('prodTags').value = Array.isArray(product.tags) ? product.tags.join(', ') : '';
      document.getElementById('prodWeight').value = product.weight || 0;
      document.getElementById('prodSKU').value = product.sku || '';

      const shippingCost = product.shippingInfo?.shippingCost ?? 0;
      document.getElementById('shippingCost').value = shippingCost;
      document.getElementById('shippingDays').value = product.shippingInfo?.estimatedDays ?? 5;
      document.getElementById('returnable').value = product.returnPolicy?.returnable === false ? 'false' : 'true';
      document.getElementById('returnDays').value = product.returnPolicy?.returnDays ?? 7;

      selectedSizes = Array.isArray(product.sizes) ? [...product.sizes] : [];
      document.querySelectorAll('#sizeChips .size-chip').forEach(chip => {
        chip.classList.toggle('active', selectedSizes.includes(chip.dataset.size));
      });

      const specsContainer = document.getElementById('specsContainer');
      const specs = Array.isArray(product.specifications) ? product.specifications.filter(s => s.key && s.value) : [];
      if (specs.length > 0) {
        specsContainer.innerHTML = specs.map(spec => `
          <div class="spec-row">
            <input type="text" class="form-input spec-key" placeholder="Specification" value="${spec.key}">
            <input type="text" class="form-input spec-val" placeholder="Value" value="${spec.value}">
            <button type="button" class="btn btn-ghost" onclick="removeSpec(this)" style="padding:8px;">
              <i data-lucide="x" style="width:16px;height:16px;"></i>
            </button>
          </div>
        `).join('');
      }

      uploadedImages = Array.isArray(product.images)
        ? product.images.map(img => ({ url: img.url, public_id: img.public_id || '' }))
        : [];
      renderImagePreviews();
      updatePricePreview();
      lucide.createIcons();
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('active');
      const overlay = document.getElementById('sidebarOverlay');
      if (overlay) overlay.classList.toggle('active');
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Load categories for dropdown ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadCategories() {
      const res = await apiCall('/categories');
      if (!res || !res.data) return;
      const sel = document.getElementById('prodCategory');
      res.data.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat._id;
        opt.textContent = `${cat.icon} ${cat.name}`;
        sel.appendChild(opt);
      });
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Load seller profile ‚îÄ‚îÄ‚îÄ‚îÄ
    async function loadSellerProfile() {
      const res = await apiCall('/sellers/profile');
      if (res && res.data) {
        document.getElementById('sidebarStoreName').textContent = res.data.storeName || 'My Store';
        if (res.data.isApproved === 'approved') {
          document.getElementById('sidebarApproval').textContent = 'Approved';
          document.getElementById('sidebarApproval').className = 'badge badge-success';
        }
      }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Price Preview ‚îÄ‚îÄ‚îÄ‚îÄ
    function updatePricePreview() {
      const price = parseFloat(document.getElementById('prodPrice').value) || 0;
      const mrp = parseFloat(document.getElementById('prodMRP').value) || 0;
      const preview = document.getElementById('pricePreview');

      if (price > 0) {
        preview.style.display = 'block';
        document.getElementById('previewPrice').textContent = `‚Çπ${price.toLocaleString('en-IN')}`;
        if (mrp > price) {
          document.getElementById('previewMRP').textContent = `‚Çπ${mrp.toLocaleString('en-IN')}`;
          const disc = Math.round(((mrp - price) / mrp) * 100);
          document.getElementById('previewDiscount').textContent = `${disc}% off`;
        } else {
          document.getElementById('previewMRP').textContent = '';
          document.getElementById('previewDiscount').textContent = '';
        }
      } else {
        preview.style.display = 'none';
      }
    }

    // Drag & Drop
    const uploadArea = document.getElementById('imageUploadArea');
    uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.style.borderColor = '#D97706'; uploadArea.style.background = '#FFFBEB'; });
    uploadArea.addEventListener('dragleave', () => { uploadArea.style.borderColor = ''; uploadArea.style.background = ''; });
    uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.style.borderColor = ''; uploadArea.style.background = ''; handleImageFiles(e.dataTransfer.files); });

    async function handleImageFiles(files) {
      if (!files || files.length === 0) return;
      const remaining = 5 - uploadedImages.length;
      if (remaining <= 0) { showToast('Maximum 5 images allowed', 'error'); return; }

      const filesToUpload = Array.from(files).slice(0, remaining);
      if (files.length > remaining) {
        showToast(`Only ${remaining} more image(s) can be uploaded`, 'warning');
      }
      const progressEl = document.getElementById('uploadProgress');
      const barEl = document.getElementById('uploadBar');
      const statusEl = document.getElementById('uploadStatus');

      progressEl.style.display = 'block';
      barEl.style.width = '10%';
      statusEl.textContent = `Uploading ${filesToUpload.length} image(s)...`;

      const validFiles = [];
      filesToUpload.forEach(file => {
        if (!file.type.startsWith('image/')) {
          showToast(`${file.name} is not an image`, 'error');
          return;
        }
        if (file.size > 5 * 1024 * 1024) {
          showToast(`${file.name} exceeds 5MB limit`, 'error');
          return;
        }
        validFiles.push(file);
      });

      if (validFiles.length === 0) {
        progressEl.style.display = 'none';
        barEl.style.width = '0%';
        return;
      }

      try {
        const formData = new FormData();
        validFiles.forEach(file => formData.append('images', file));
        formData.append('folder', 'dealify/products');

        const auth = getAuth();
        const resp = await fetch(API_BASE_URL + '/upload/multiple', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${auth.token}` },
          body: formData,
        });
        const data = await resp.json().catch(() => null);

        if (resp.ok && data && data.success && Array.isArray(data.data)) {
          uploadedImages.push(...data.data);
          barEl.style.width = '100%';
          statusEl.textContent = `Uploaded ${data.data.length} image(s)`;
          showToast('Images uploaded successfully', 'success');
        } else {
          let uploadedCount = 0;
          for (const file of validFiles) {
            const single = await uploadSingleImage(file);
            if (single) {
              uploadedImages.push(single);
              uploadedCount++;
            }
          }

          if (uploadedCount > 0) {
            barEl.style.width = '100%';
            statusEl.textContent = `Uploaded ${uploadedCount} image(s)`;
            showToast(`Uploaded ${uploadedCount} image(s)`, 'success');
          } else {
            showToast((data && data.message) || 'Image upload failed', 'error');
          }
        }
      } catch (err) {
        let uploadedCount = 0;
        for (const file of validFiles) {
          const single = await uploadSingleImage(file);
          if (single) {
            uploadedImages.push(single);
            uploadedCount++;
          }
        }
        if (uploadedCount > 0) {
          barEl.style.width = '100%';
          statusEl.textContent = `Uploaded ${uploadedCount} image(s)`;
          showToast(`Uploaded ${uploadedCount} image(s)`, 'success');
        } else {
          showToast('Upload failed: ' + err.message, 'error');
        }
      }

      setTimeout(() => { progressEl.style.display = 'none'; barEl.style.width = '0%'; }, 1500);
      renderImagePreviews();
      document.getElementById('imageFileInput').value = '';
    }

    async function uploadSingleImage(file) {
      try {
        const formData = new FormData();
        formData.append('image', file);
        formData.append('folder', 'dealify/products');

        const auth = getAuth();
        const resp = await fetch(API_BASE_URL + '/upload', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${auth.token}` },
          body: formData,
        });

        const data = await resp.json().catch(() => null);
        if (resp.ok && data && data.success && data.data) {
          return data.data;
        }
        return null;
      } catch (_) {
        return null;
      }
    }

    function renderImagePreviews() {
      const grid = document.getElementById('imagePreviewGrid');
      grid.innerHTML = uploadedImages.map((img, i) => `
        <div class="image-preview">
          <img src="${img.url}" alt="Product image ${i + 1}">
          <button type="button" class="remove-img" onclick="removeImage(${i})" title="Remove">&times;</button>
        </div>
      `).join('');
    }

    function removeImage(index) {
      uploadedImages.splice(index, 1);
      renderImagePreviews();
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Sizes ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleSize(el) {
      const size = el.dataset.size;
      el.classList.toggle('active');
      if (el.classList.contains('active')) {
        selectedSizes.push(size);
      } else {
        selectedSizes = selectedSizes.filter(s => s !== size);
      }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Specifications ‚îÄ‚îÄ‚îÄ‚îÄ
    function addSpec() {
      const container = document.getElementById('specsContainer');
      const row = document.createElement('div');
      row.className = 'spec-row';
      row.innerHTML = `
        <input type="text" class="form-input spec-key" placeholder="Specification">
        <input type="text" class="form-input spec-val" placeholder="Value">
        <button type="button" class="btn btn-ghost" onclick="removeSpec(this)" style="padding:8px;">
          <i data-lucide="x" style="width:16px;height:16px;"></i>
        </button>
      `;
      container.appendChild(row);
      lucide.createIcons();
    }

    function removeSpec(btn) {
      const row = btn.closest('.spec-row');
      const container = document.getElementById('specsContainer');
      if (container.children.length > 1) {
        row.remove();
      } else {
        row.querySelectorAll('input').forEach(i => i.value = '');
      }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ Form Submit ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const name = document.getElementById('prodName').value.trim();
      const price = parseFloat(document.getElementById('prodPrice').value);
      const category = document.getElementById('prodCategory').value;

      if (!name) { showToast('Product name is required', 'error'); return; }
      if (!price || price <= 0) { showToast('Valid selling price is required', 'error'); return; }
      if (!category) { showToast('Please select a category', 'error'); return; }

      // Build data
      const images = uploadedImages.map(img => ({ url: img.url, alt: name }));

      const specifications = [];
      document.querySelectorAll('.spec-row').forEach(row => {
        const key = row.querySelector('.spec-key').value.trim();
        const val = row.querySelector('.spec-val').value.trim();
        if (key && val) specifications.push({ key, value: val });
      });

      const tags = document.getElementById('prodTags').value
        .split(',').map(t => t.trim()).filter(t => t);

      const body = {
        name,
        shortDescription: document.getElementById('prodShortDesc').value.trim(),
        description: document.getElementById('prodDescription').value.trim(),
        category,
        brand: document.getElementById('prodBrand').value.trim(),
        price,
        mrp: parseFloat(document.getElementById('prodMRP').value) || price,
        stock: parseInt(document.getElementById('prodStock').value) || 0,
        images,
        specifications,
        sizes: selectedSizes,
        tags,
        weight: parseFloat(document.getElementById('prodWeight').value) || 0,
        sku: document.getElementById('prodSKU').value.trim(),
        shippingInfo: {
          freeShipping: (parseFloat(document.getElementById('shippingCost').value) || 0) === 0,
          shippingCost: parseFloat(document.getElementById('shippingCost').value) || 0,
          estimatedDays: parseInt(document.getElementById('shippingDays').value) || 5,
        },
        returnPolicy: {
          returnable: document.getElementById('returnable').value === 'true',
          returnDays: parseInt(document.getElementById('returnDays').value) || 7,
        },
      };

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = `<i data-lucide="loader" style="width:18px;height:18px;" class="spin"></i> ${editProductId ? 'Saving...' : 'Submitting...'}`;

      const endpoint = editProductId ? `/products/${editProductId}` : '/products';
      const method = editProductId ? 'PUT' : 'POST';
      const res = await apiCall(endpoint, method, body);

      submitBtn.disabled = false;
      submitBtn.innerHTML = editProductId
        ? '<i data-lucide="save" style="width:18px;height:18px;"></i> Save Changes'
        : '<i data-lucide="check" style="width:18px;height:18px;"></i> Submit Product';
      lucide.createIcons();

      if (res && res.success) {
        showToast(editProductId ? 'Product updated successfully! ‚úÖ' : 'Product submitted for approval! üéâ', 'success');
        setTimeout(() => { window.location.href = 'products.html'; }, 1500);
      } else if (res) {
        showToast(res.message || (editProductId ? 'Failed to update product' : 'Failed to create product'), 'error');
      }
    });
  </script>
<button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
</body>
</html>
